<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Financeiro - Controle Pessoal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        /* Anima√ß√£o minimalista - Flocos de Neve sutis */
        .snowflake {
            position: fixed;
            top: -10px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.8em;
            font-family: Arial, sans-serif;
            animation: fallSlow linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes fallSlow {
            to {
                transform: translateY(100vh) rotate(180deg);
            }
        }

        /* Garantir que o conte√∫do fique acima das anima√ß√µes */
        .container, .header {
            position: relative;
            z-index: 1;
        }

        .header {
            background: #0a0a0a;
            border-bottom: 1px solid #222;
            padding: 25px 40px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: #fff;
        }

        .header .subtitle {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 0;
            padding: 24px;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #333;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.85rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .card-value.positive {
            color: #4ade80;
        }

        .card-value.negative {
            color: #f87171;
        }

        .card-footer {
            font-size: 0.75rem;
            color: #888;
            margin-top: 10px;
        }

        .card.saldo {
            background: #0a0a0a;
            border-color: #333;
        }

        .card.receitas {
            border-left: 3px solid #4ade80;
        }

        .card.gastos {
            border-left: 3px solid #f87171;
        }

        .section {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #222;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .form-section {
            background: #0a0a0a;
            border: 1px solid #222;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            background-color: #0a0a0a;
            border: 1px solid #333;
            border-radius: 0;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4ade80;
        }

        button {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #e5e5e5;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transactions-table th {
            background-color: #0a0a0a;
            padding: 15px;
            text-align: left;
            font-size: 0.85rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            border-bottom: 1px solid #222;
        }

        .transactions-table td {
            padding: 15px;
            border-bottom: 1px solid #222;
            font-size: 0.9rem;
        }

        .transactions-table tr:hover {
            background-color: #1a1a1a;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.receita {
            background-color: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border: none;
        }

        .badge.debito {
            background-color: rgba(248, 113, 113, 0.15);
            color: #f87171;
            border: none;
        }

        .badge.mercado-pago {
            background-color: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: none;
        }

        .badge.nubank {
            background-color: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: none;
        }

        .badge.parcela {
            background-color: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: none;
        }

        .delete-btn {
            background: transparent;
            color: #f87171;
            border: 1px solid #f87171;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 0;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .delete-btn:hover {
            background-color: #f87171;
            color: #000;
        }

        .edit-btn {
            background: transparent;
            color: #3b82f6;
            border: 1px solid #3b82f6;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 0;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background-color: #3b82f6;
            color: #000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }

        .modal-content {
            background: #0a0a0a;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #222;
            border-radius: 0;
            width: 90%;
            max-width: 600px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 300;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background-color: #0a0a0a;
            border-radius: 0;
            border: 1px solid #222;
            transition: border-color 0.2s;
        }

        .stat-item:hover {
            border-color: #333;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert.success {
            background-color: rgba(74, 222, 128, 0.1);
            border-color: #4ade80;
            color: #4ade80;
            border-left-width: 3px;
        }

        .alert.error {
            background-color: rgba(248, 113, 113, 0.1);
            border-color: #f87171;
            color: #f87171;
            border-left-width: 3px;
        }

        .alert.info {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
            border-left-width: 3px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Anima√ß√£o minimalista - Flocos de Neve sutis -->
    <div id="snowflakes"></div>

    <div class="header">
        <h1>üè¶ Banco Financeiro</h1>
        <div class="subtitle">Controle Financeiro Pessoal Completo</div>
    </div>

    <div class="container">
        <!-- Filtro de M√™s para Cards -->
        <div style="margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
            <label for="dashboardMonth" style="color: #888; font-size: 0.85rem;">M√™s:</label>
            <select id="dashboardMonth" style="padding: 8px 12px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 0.9rem; min-width: 200px;">
                <option value="">Carregando...</option>
            </select>
        </div>

        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <div class="card" style="border-left: 4px solid #3b82f6;">
                <div class="card-header">
                    <div class="card-title">Saldo Atual</div>
                    <div class="card-icon">üíµ</div>
                </div>
                <div class="card-value" id="saldoAtual">R$ 0,00</div>
                <div class="card-footer">Saldo acumulado at√© o m√™s selecionado</div>
            </div>

            <div class="card" style="border-left: 4px solid #10b981;">
                <div class="card-header">
                    <div class="card-title">Saldo Projetado</div>
                    <div class="card-icon">üìä</div>
                </div>
                <div class="card-value" id="saldoProjetado">R$ 0,00</div>
                <div class="card-footer">Saldo projetado acumulado (com faturas)</div>
            </div>

            <div class="card receitas">
                <div class="card-header">
                    <div class="card-title">Total Receitas</div>
                    <div class="card-icon">üìà</div>
                </div>
                <div class="card-value positive" id="totalReceitas">R$ 0,00</div>
                <div class="card-footer" id="mediaReceitas">M√©dia mensal: R$ 0,00</div>
            </div>

            <div class="card gastos">
                <div class="card-header">
                    <div class="card-title">Total Gastos</div>
                    <div class="card-icon">üìâ</div>
                </div>
                <div class="card-value negative" id="totalGastos">R$ 0,00</div>
                <div class="card-footer" id="mediaGastos">M√©dia mensal: R$ 0,00</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Transa√ß√µes</div>
                    <div class="card-icon">üìä</div>
                </div>
                <div class="card-value" id="totalTransacoes">0</div>
                <div class="card-footer" id="parceladasInfo">0 compras parceladas</div>
            </div>
        </div>

        <!-- Cards de Faturas dos Cart√µes -->
        <div class="dashboard-grid" style="margin-top: 30px;">
            <div class="card" style="border-left: 4px solid #fbbf24;">
                <div class="card-header">
                    <div class="card-title">Mercado Pago - Fatura Atual</div>
                    <div class="card-icon">üõí</div>
                </div>
                <div class="card-value negative" id="faturaAtualMP">R$ 0,00</div>
                <div class="card-footer">Pendente de pagamento</div>
            </div>

            <div class="card" style="border-left: 4px solid #fbbf24;">
                <div class="card-header">
                    <div class="card-title">Mercado Pago - Abatido</div>
                    <div class="card-icon">‚úÖ</div>
                </div>
                <div class="card-value" id="faturaAbatidaMP">R$ 0,00</div>
                <div class="card-footer">Total j√° abatido</div>
            </div>

            <div class="card" style="border-left: 4px solid #a855f7;">
                <div class="card-header">
                    <div class="card-title">Nubank - Fatura Atual</div>
                    <div class="card-icon">üíú</div>
                </div>
                <div class="card-value negative" id="faturaAtualNubank">R$ 0,00</div>
                <div class="card-footer">Pendente de pagamento</div>
            </div>

            <div class="card" style="border-left: 4px solid #a855f7;">
                <div class="card-header">
                    <div class="card-title">Nubank - Abatido</div>
                    <div class="card-icon">‚úÖ</div>
                </div>
                <div class="card-value" id="faturaAbatidaNubank">R$ 0,00</div>
                <div class="card-footer">Total j√° abatido</div>
            </div>
        </div>

        <!-- Formul√°rio de Abatimento -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">üí∞ Abater Fatura / Dep√≥sito</h2>
            </div>
            <form id="abatimentoForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo_cartao_abatimento">Cart√£o</label>
                        <select id="tipo_cartao_abatimento" name="tipo_cartao" required>
                            <option value="">Selecione...</option>
                            <option value="mercado_pago">üõí Mercado Pago</option>
                            <option value="nubank">üíú Nubank</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valor_abatimento">Valor do Abatimento (R$)</label>
                        <input type="number" id="valor_abatimento" name="valor" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="data_abatimento">Data</label>
                        <input type="date" id="data_abatimento" name="data" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="descricao_abatimento">Descri√ß√£o (opcional)</label>
                        <input type="text" id="descricao_abatimento" name="descricao" placeholder="Ex: Dep√≥sito para pagar fatura...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit">Adicionar Abatimento</button>
                    </div>
                </div>
                <div id="abatimentoMessage" class="alert" style="display: none;"></div>
            </form>
        </div>

        <!-- Formul√°rio de Transa√ß√£o -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">‚ûï Nova Transa√ß√£o</h2>
            </div>
            <form id="transactionForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo">Tipo de Transa√ß√£o</label>
                        <select id="tipo" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="receita">üí∞ Receita</option>
                            <option value="debito">üí≥ Gasto - D√©bito</option>
                            <option value="mercado_pago">üõí Gasto - Cart√£o Mercado Pago</option>
                            <option value="nubank">üíú Gasto - Cart√£o Nubank</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valor">Valor Total (R$)</label>
                        <input type="number" id="valor" name="valor" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="num_parcelas">N√∫mero de Parcelas</label>
                        <input type="number" id="num_parcelas" name="num_parcelas" min="1" value="1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="descricao">Descri√ß√£o</label>
                        <input type="text" id="descricao" name="descricao" required placeholder="Ex: Sal√°rio, Supermercado, Roupas...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="data">Data da Primeira Parcela</label>
                        <input type="date" id="data" name="data" required>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit">Adicionar Transa√ß√£o</button>
                    </div>
                </div>
                <div id="parcelasInfo" style="display: none; padding: 15px; background: #0a0a0a; border-radius: 4px; margin-top: 15px; color: #aaa; font-size: 0.9rem;"></div>
                <div id="successMessage" class="alert" style="display: none;"></div>
            </form>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üìà Evolu√ß√£o Mensal</h2>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üí≥ Distribui√ß√£o de Gastos</h2>
                </div>
                <div class="chart-container">
                    <canvas id="gastosChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">üìä Estat√≠sticas Detalhadas</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Gastos em D√©bito</div>
                    <div class="stat-value" id="statDebito">R$ 0,00</div>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;" id="pctDebito">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Gastos Mercado Pago</div>
                    <div class="stat-value" id="statMercadoPago">R$ 0,00</div>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;" id="pctMercadoPago">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Gastos Nubank</div>
                    <div class="stat-value" id="statNubank">R$ 0,00</div>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;" id="pctNubank">0%</div>
                </div>
            </div>
        </div>

        <!-- Lista de Abatimentos -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">üí∞ Hist√≥rico de Abatimentos</h2>
            </div>
            <div style="overflow-x: auto;">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cart√£o</th>
                            <th>Descri√ß√£o</th>
                            <th>Valor</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="abatimentosTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #888; padding: 40px;">Carregando abatimentos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabela de Transa√ß√µes -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">üìã Hist√≥rico de Transa√ß√µes</h2>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label for="filterMes" style="margin: 0;">M√™s:</label>
                    <select id="filterMes" style="width: auto; min-width: 180px;">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterTipo" style="margin: 0;">Tipo:</label>
                    <select id="filterTipo" style="width: auto; min-width: 150px;">
                        <option value="">Todos</option>
                        <option value="receita">Receitas</option>
                        <option value="debito">D√©bito</option>
                        <option value="mercado_pago">Mercado Pago</option>
                        <option value="nubank">Nubank</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterBusca" style="margin: 0;">Buscar:</label>
                    <input type="text" id="filterBusca" placeholder="Descri√ß√£o..." style="width: auto; min-width: 200px;">
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <button type="button" id="deleteSelectedBtn" style="background: #f87171; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; display: none;" onclick="deleteSelectedTransactions()">Excluir Selecionados</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Parcela</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #888; padding: 40px;">Carregando transa√ß√µes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Abatimento -->
    <div id="editAbatimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Editar Abatimento</h2>
                <span class="close" onclick="closeEditAbatimentoModal()">&times;</span>
            </div>
            <form id="editAbatimentoForm">
                <input type="hidden" id="editAbatimentoId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editAbatimentoTipoCartao">Cart√£o</label>
                        <select id="editAbatimentoTipoCartao" required>
                            <option value="">Selecione...</option>
                            <option value="mercado_pago">üõí Mercado Pago</option>
                            <option value="nubank">üíú Nubank</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAbatimentoValor">Valor do Abatimento (R$)</label>
                        <input type="number" id="editAbatimentoValor" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="editAbatimentoData">Data</label>
                        <input type="date" id="editAbatimentoData" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="editAbatimentoDescricao">Descri√ß√£o (opcional)</label>
                        <input type="text" id="editAbatimentoDescricao" placeholder="Ex: Dep√≥sito para pagar fatura...">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditAbatimentoModal()" style="background: transparent; border: 1px solid #333; color: #fff;">Cancelar</button>
                    <button type="submit">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Editar Transa√ß√£o</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editTipo">
                <input type="hidden" id="editParcelGroupId">
                <input type="hidden" id="editParcelado">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editTipoSelect">Tipo de Transa√ß√£o</label>
                        <select id="editTipoSelect" required>
                            <option value="">Selecione...</option>
                            <option value="receita">üí∞ Receita</option>
                            <option value="debito">üí≥ Gasto - D√©bito</option>
                            <option value="mercado_pago">üõí Gasto - Cart√£o Mercado Pago</option>
                            <option value="nubank">üíú Gasto - Cart√£o Nubank</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editValor">Valor</label>
                        <input type="number" id="editValor" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="editDescricao">Descri√ß√£o</label>
                        <input type="text" id="editDescricao" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editData">Data</label>
                        <input type="date" id="editData" required>
                    </div>
                    <div class="form-group" id="editParcelasGroup" style="display: none;">
                        <label for="editNumParcelas">N√∫mero de Parcelas</label>
                        <input type="number" id="editNumParcelas" min="1" value="1">
                    </div>
                </div>
                <div id="editParcelasInfo" style="display: none; padding: 15px; background: #0a0a0a; border-radius: 4px; margin-bottom: 20px; color: #aaa; font-size: 0.9rem;"></div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeEditModal()" style="background: transparent; border: 1px solid #333; color: #fff;">Cancelar</button>
                    <button type="submit">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let monthlyChart = null;
        let gastosChart = null;
        let allTransactions = [];

        // Formata valor
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Formata data
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        // Atualiza info de parcelas
        function updateParcelasInfo() {
            const numParcelas = parseInt(document.getElementById('num_parcelas').value) || 1;
            const valorTotal = parseFloat(document.getElementById('valor').value) || 0;
            const infoDiv = document.getElementById('parcelasInfo');
            
            if (numParcelas > 1 && valorTotal > 0) {
                const valorParcela = valorTotal / numParcelas;
                infoDiv.innerHTML = `<strong>‚ÑπÔ∏è Informa√ß√£o:</strong> ${numParcelas}x de ${formatCurrency(valorParcela)} = Total: ${formatCurrency(valorTotal)}`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Obt√©m meses √∫nicos das transa√ß√µes
        function getAvailableMonths(transactions) {
            const months = new Set();
            transactions.forEach(t => {
                const transDate = new Date(t.data + 'T00:00:00');
                const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                months.add(monthKey);
            });
            
            const mesesNomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            return Array.from(months)
                .sort()
                .reverse() // Mais recente primeiro
                .map(monthKey => {
                    const [year, month] = monthKey.split('-');
                    const monthName = mesesNomes[parseInt(month) - 1];
                    return {
                        value: monthKey,
                        label: `${monthName}/${year}`
                    };
                });
        }

        // Popula dropdowns de m√™s
        function populateMonthDropdowns() {
            const months = getAvailableMonths(allTransactions);
            const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
            
            // Popula dropdown do dashboard
            const dashboardSelect = document.getElementById('dashboardMonth');
            dashboardSelect.innerHTML = '<option value="">Todos os meses</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                if (month.value === currentMonth) {
                    option.selected = true;
                }
                dashboardSelect.appendChild(option);
            });
            
            // Popula dropdown da tabela
            const tableSelect = document.getElementById('filterMes');
            tableSelect.innerHTML = '<option value="">Todos os meses</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                if (month.value === currentMonth) {
                    option.selected = true;
                }
                tableSelect.appendChild(option);
            });
        }

        // Carrega transa√ß√µes
        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                
                // Flatten todas as transa√ß√µes
                allTransactions = [
                    ...(data.receitas || []).map(t => ({...t, tipo: 'receita'})),
                    ...(data.gastos_debito || []).map(t => ({...t, tipo: 'debito'})),
                    ...(data.gastos_mercado_pago || []).map(t => ({...t, tipo: 'mercado_pago'})),
                    ...(data.gastos_nubank || []).map(t => ({...t, tipo: 'nubank'}))
                ].sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Popula dropdowns de m√™s
                populateMonthDropdowns();
                
                // Obt√©m o m√™s do filtro do dashboard
                const dashboardMonth = document.getElementById('dashboardMonth').value;
                
                renderTransactions();
                updateDashboard(data, dashboardMonth);
                await loadCharts();
                await loadStatistics();
                await loadFaturas();
                await atualizarSaldos();
            } catch (error) {
                console.error('Erro ao carregar transa√ß√µes:', error);
            }
        }

        // Renderiza tabela de transa√ß√µes
        function renderTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const filterTipo = document.getElementById('filterTipo').value;
            const filterBusca = document.getElementById('filterBusca').value.toLowerCase();
            const filterMes = document.getElementById('filterMes').value; // Formato: YYYY-MM
            
            let filtered = allTransactions;
            
            // Filtro por m√™s (padr√£o: m√™s atual)
            if (filterMes) {
                filtered = filtered.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMes;
                });
            }
            
            if (filterTipo) {
                filtered = filtered.filter(t => t.tipo === filterTipo);
            }
            
            if (filterBusca) {
                filtered = filtered.filter(t => 
                    t.descricao.toLowerCase().includes(filterBusca)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888; padding: 40px;">Nenhuma transa√ß√£o encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(transaction => {
                const tipoLabels = {
                    'receita': 'üí∞ Receita',
                    'debito': 'üí≥ D√©bito',
                    'mercado_pago': 'üõí Mercado Pago',
                    'nubank': 'üíú Nubank'
                };
                
                const tipoBadges = {
                    'receita': 'receita',
                    'debito': 'debito',
                    'mercado_pago': 'mercado-pago',
                    'nubank': 'nubank'
                };
                
                const parcelaInfo = transaction.parcelado 
                    ? `<span class="badge parcela">${transaction.parcela_atual}/${transaction.total_parcelas}</span>`
                    : '-';
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="transaction-checkbox" value="${transaction.tipo}|${transaction.id}" onchange="updateDeleteButton()">
                        </td>
                        <td>${formatDate(transaction.data)}</td>
                        <td>${transaction.descricao}</td>
                        <td><span class="badge ${tipoBadges[transaction.tipo]}">${tipoLabels[transaction.tipo]}</span></td>
                        <td style="font-weight: 500; ${transaction.tipo === 'receita' ? 'color: #4ade80;' : 'color: #f87171;'}">${formatCurrency(transaction.valor)}</td>
                        <td>${parcelaInfo}</td>
                        <td>
                            <div class="btn-group">
                                <button class="edit-btn" onclick="openEditModal(${JSON.stringify(transaction).replace(/"/g, '&quot;')})">Editar</button>
                                <button class="delete-btn" onclick="deleteTransaction('${transaction.tipo}', '${transaction.id}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateDeleteButton();
        }

        // Calcula saldo acumulado at√© um m√™s espec√≠fico
        function calculateAccumulatedBalance(data, targetMonth) {
            if (!targetMonth) {
                // Se n√£o h√° filtro, calcula saldo total de todos os meses
                const receitas = (data.receitas || []).reduce((sum, t) => sum + t.valor, 0);
                const debito = (data.gastos_debito || []).reduce((sum, t) => sum + t.valor, 0);
                const mercadoPago = (data.gastos_mercado_pago || []).reduce((sum, t) => sum + t.valor, 0);
                const nubank = (data.gastos_nubank || []).reduce((sum, t) => sum + t.valor, 0);
                const gastos = debito + mercadoPago + nubank;
                return receitas - gastos;
            }
            
            // Agrupa transa√ß√µes por m√™s
            const monthlyData = {};
            
            // Processa todas as transa√ß√µes
            [...(data.receitas || []), ...(data.gastos_debito || []), 
             ...(data.gastos_mercado_pago || []), ...(data.gastos_nubank || [])].forEach(t => {
                const transDate = new Date(t.data + 'T00:00:00');
                const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { receitas: 0, gastos: 0 };
                }
                
                if (t.tipo === 'receita' || (data.receitas || []).includes(t)) {
                    monthlyData[monthKey].receitas += t.valor;
                } else {
                    monthlyData[monthKey].gastos += t.valor;
                }
            });
            
            // Ordena meses cronologicamente
            const sortedMonths = Object.keys(monthlyData).sort();
            
            // Calcula saldo acumulado at√© o m√™s alvo (inclusive)
            let accumulatedBalance = 0;
            for (const month of sortedMonths) {
                const monthBalance = monthlyData[month].receitas - monthlyData[month].gastos;
                accumulatedBalance += monthBalance;
                
                // Para quando chegar no m√™s alvo
                if (month === targetMonth) {
                    break;
                }
            }
            
            return accumulatedBalance;
        }

        // Atualiza dashboard
        function updateDashboard(data, filterMonth = null) {
            // Filtra transa√ß√µes por m√™s se especificado
            let receitasList = data.receitas || [];
            let debitoList = data.gastos_debito || [];
            let mercadoPagoList = data.gastos_mercado_pago || [];
            let nubankList = data.gastos_nubank || [];
            
            if (filterMonth) {
                receitasList = receitasList.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMonth;
                });
                debitoList = debitoList.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMonth;
                });
                mercadoPagoList = mercadoPagoList.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMonth;
                });
                nubankList = nubankList.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMonth;
                });
            }
            
            const receitas = receitasList.reduce((sum, t) => sum + t.valor, 0);
            const debito = debitoList.reduce((sum, t) => sum + t.valor, 0);
            const mercadoPago = mercadoPagoList.reduce((sum, t) => sum + t.valor, 0);
            const nubank = nubankList.reduce((sum, t) => sum + t.valor, 0);
            const gastos = debito + mercadoPago + nubank;
            
            document.getElementById('totalReceitas').textContent = formatCurrency(receitas);
            document.getElementById('totalGastos').textContent = formatCurrency(gastos);
            
            // Conta transa√ß√µes do m√™s filtrado
            const filteredTransactions = filterMonth 
                ? allTransactions.filter(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const transMonth = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    return transMonth === filterMonth;
                })
                : allTransactions;
            
            const totalTransacoes = filteredTransactions.length;
            document.getElementById('totalTransacoes').textContent = totalTransacoes;
            
            // Atualiza m√©dia mensal (s√≥ faz sentido se n√£o estiver filtrado por m√™s)
            if (!filterMonth) {
                // Calcula m√©dia baseada em todos os meses dispon√≠veis
                const monthlyData = {};
                [...receitasList, ...debitoList, ...mercadoPagoList, ...nubankList].forEach(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = true;
                });
                const numMonths = Object.keys(monthlyData).length || 1;
                document.getElementById('mediaReceitas').textContent = 
                    'M√©dia mensal: ' + formatCurrency(receitas / numMonths);
                document.getElementById('mediaGastos').textContent = 
                    'M√©dia mensal: ' + formatCurrency(gastos / numMonths);
            } else {
                // Se est√° filtrado por m√™s, mostra apenas os valores do m√™s
                document.getElementById('mediaReceitas').textContent = 'M√™s atual';
                document.getElementById('mediaGastos').textContent = 'M√™s atual';
            }
        }

        // Carrega gr√°ficos
        async function loadCharts() {
            try {
                // Busca dados mensais para o gr√°fico de linha
                const monthlyResponse = await fetch('/api/transactions/monthly');
                const monthlyData = await monthlyResponse.json();
                
                // Busca todas as transa√ß√µes para o gr√°fico de distribui√ß√£o
                const transactionsResponse = await fetch('/api/transactions');
                const transactionsData = await transactionsResponse.json();
                
                // Calcula totais de gastos por tipo
                const totalDebito = (transactionsData.gastos_debito || []).reduce((sum, t) => sum + t.valor, 0);
                const totalMercadoPago = (transactionsData.gastos_mercado_pago || []).reduce((sum, t) => sum + t.valor, 0);
                const totalNubank = (transactionsData.gastos_nubank || []).reduce((sum, t) => sum + t.valor, 0);
                const totalGastos = totalDebito + totalMercadoPago + totalNubank;
                
                // Gr√°fico mensal - simplificado
                if (monthlyChart) monthlyChart.destroy();
                const ctx1 = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: monthlyData.meses || [],
                        datasets: [
                            {
                                label: 'Receitas',
                                data: monthlyData.receitas || [],
                                borderColor: '#4ade80',
                                backgroundColor: 'rgba(74, 222, 128, 0.2)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Gastos',
                                data: monthlyData.gastos || [],
                                borderColor: '#f87171',
                                backgroundColor: 'rgba(248, 113, 113, 0.2)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Saldo',
                                data: monthlyData.saldos || [],
                                borderColor: '#3b82f6',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [8, 4],
                                tension: 0.3,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                labels: { 
                                    color: '#fff',
                                    font: { size: 12 },
                                    padding: 15,
                                    usePointStyle: true
                                },
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#333',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: (ctx) => {
                                        return ctx.dataset.label + ': ' + formatCurrency(ctx.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { 
                                    color: '#aaa',
                                    font: { size: 11 }
                                }, 
                                grid: { 
                                    color: '#222',
                                    drawBorder: false
                                } 
                            },
                            y: {
                                ticks: {
                                    color: '#aaa',
                                    font: { size: 11 },
                                    callback: (value) => {
                                        if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(1) + 'k';
                                        return formatCurrency(value);
                                    }
                                },
                                grid: { 
                                    color: '#222',
                                    drawBorder: false
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Gr√°fico de distribui√ß√£o de gastos - simplificado e funcional
                if (gastosChart) gastosChart.destroy();
                const ctx2 = document.getElementById('gastosChart').getContext('2d');
                
                // S√≥ mostra o gr√°fico se houver gastos
                if (totalGastos > 0) {
                    gastosChart = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['D√©bito', 'Mercado Pago', 'Nubank'],
                            datasets: [{
                                data: [totalDebito, totalMercadoPago, totalNubank],
                                backgroundColor: [
                                    '#f87171',
                                    '#fbbf24',
                                    '#a855f7'
                                ],
                                borderColor: '#0a0a0a',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            plugins: {
                                legend: { 
                                    labels: { 
                                        color: '#fff',
                                        font: { size: 12 },
                                        padding: 12,
                                        usePointStyle: true
                                    }, 
                                    position: 'bottom'
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: '#333',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: (ctx) => {
                                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                            const percent = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                            return ctx.label + ': ' + formatCurrency(ctx.parsed) + ' (' + percent + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // Se n√£o houver gastos, mostra mensagem
                    ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);
                    ctx2.fillStyle = '#888';
                    ctx2.font = '14px sans-serif';
                    ctx2.textAlign = 'center';
                    ctx2.fillText('Nenhum gasto registrado', ctx2.canvas.width / 2, ctx2.canvas.height / 2);
                }
            } catch (error) {
                console.error('Erro ao carregar gr√°ficos:', error);
            }
        }

        // Carrega estat√≠sticas (filtradas por m√™s se especificado)
        async function loadStatistics() {
            try {
                const dashboardMonth = document.getElementById('dashboardMonth').value;
                const monthParam = dashboardMonth ? `?month=${dashboardMonth}` : '';
                const response = await fetch('/api/statistics' + monthParam);
                const stats = await response.json();
                
                document.getElementById('statDebito').textContent = formatCurrency(stats.total_debito);
                document.getElementById('statMercadoPago').textContent = formatCurrency(stats.total_mercado_pago);
                document.getElementById('statNubank').textContent = formatCurrency(stats.total_nubank);
                
                document.getElementById('pctDebito').textContent = stats.pct_debito.toFixed(1) + '% do total';
                document.getElementById('pctMercadoPago').textContent = stats.pct_mercado_pago.toFixed(1) + '% do total';
                document.getElementById('pctNubank').textContent = stats.pct_nubank.toFixed(1) + '% do total';
                
                document.getElementById('parceladasInfo').textContent = 
                    stats.compras_parceladas + ' compras parceladas';
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Deleta transa√ß√£o (mant√©m filtro)
        async function deleteTransaction(tipo, id) {
            if (!confirm('Deseja realmente excluir esta transa√ß√£o?')) return;
            
            // Salva o filtro atual
            const currentFilterMes = document.getElementById('filterMes').value;
            const currentFilterTipo = document.getElementById('filterTipo').value;
            const currentFilterBusca = document.getElementById('filterBusca').value;
            
            try {
                const response = await fetch(`/api/transactions/${tipo}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await loadTransactions();
                    // Restaura os filtros
                    document.getElementById('filterMes').value = currentFilterMes;
                    document.getElementById('filterTipo').value = currentFilterTipo;
                    document.getElementById('filterBusca').value = currentFilterBusca;
                    renderTransactions();
                    showMessage('Transa√ß√£o exclu√≠da com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showMessage('Erro ao excluir transa√ß√£o', 'error');
            }
        }

        // Seleciona/deseleciona todos
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateDeleteButton();
        }

        // Atualiza visibilidade do bot√£o de excluir selecionados
        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (checkboxes.length > 0) {
                deleteBtn.style.display = 'block';
                deleteBtn.textContent = `Excluir Selecionados (${checkboxes.length})`;
            } else {
                deleteBtn.style.display = 'none';
            }
            // Atualiza checkbox "selecionar todos"
            const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
            const selectAll = document.getElementById('selectAll');
            if (allCheckboxes.length > 0) {
                selectAll.checked = checkboxes.length === allCheckboxes.length;
            }
        }

        // Exclui transa√ß√µes selecionadas
        async function deleteSelectedTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            if (!confirm(`Deseja realmente excluir ${checkboxes.length} transa√ß√£o(√µes)?`)) return;
            
            // Salva o filtro atual
            const currentFilterMes = document.getElementById('filterMes').value;
            const currentFilterTipo = document.getElementById('filterTipo').value;
            const currentFilterBusca = document.getElementById('filterBusca').value;
            
            const transactionsToDelete = Array.from(checkboxes).map(cb => {
                const [tipo, id] = cb.value.split('|');
                return { tipo, id };
            });
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const { tipo, id } of transactionsToDelete) {
                    try {
                        const response = await fetch(`/api/transactions/${tipo}/${id}`, { method: 'DELETE' });
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }
                
                await loadTransactions();
                // Restaura os filtros
                document.getElementById('filterMes').value = currentFilterMes;
                document.getElementById('filterTipo').value = currentFilterTipo;
                document.getElementById('filterBusca').value = currentFilterBusca;
                renderTransactions();
                
                if (errorCount === 0) {
                    showMessage(`${successCount} transa√ß√£o(√µes) exclu√≠da(s) com sucesso!`, 'success');
                } else {
                    showMessage(`${successCount} exclu√≠da(s), ${errorCount} erro(s)`, 'error');
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showMessage('Erro ao excluir transa√ß√µes', 'error');
            }
        }

        // Mostra mensagem
        function showMessage(text, type) {
            const msg = document.getElementById('successMessage');
            msg.textContent = text;
            msg.className = 'alert ' + type;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        // Submit do formul√°rio
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                tipo: document.getElementById('tipo').value,
                descricao: document.getElementById('descricao').value,
                valor: parseFloat(document.getElementById('valor').value),
                data: document.getElementById('data').value,
                num_parcelas: parseInt(document.getElementById('num_parcelas').value) || 1
            };
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Salva o filtro atual
                    const currentFilterMes = document.getElementById('filterMes').value;
                    const currentFilterTipo = document.getElementById('filterTipo').value;
                    const currentFilterBusca = document.getElementById('filterBusca').value;
                    
                    document.getElementById('transactionForm').reset();
                    document.getElementById('num_parcelas').value = 1;
                    document.getElementById('data').valueAsDate = new Date();
                    document.getElementById('parcelasInfo').style.display = 'none';
                    showMessage('‚úì Transa√ß√£o adicionada com sucesso!', 'success');
                    await loadTransactions();
                    // Restaura os filtros
                    document.getElementById('filterMes').value = currentFilterMes;
                    document.getElementById('filterTipo').value = currentFilterTipo;
                    document.getElementById('filterBusca').value = currentFilterBusca;
                    renderTransactions();
                } else {
                    showMessage('‚úó Erro: ' + (result.error || 'Erro ao adicionar'), 'error');
                }
            } catch (error) {
                showMessage('‚úó Erro de conex√£o: ' + error.message, 'error');
            }
        });

        // Abre modal de edi√ß√£o
        function openEditModal(transaction) {
            const modal = document.getElementById('editModal');
            document.getElementById('editId').value = transaction.id;
            document.getElementById('editTipo').value = transaction.tipo;
            document.getElementById('editTipoSelect').value = transaction.tipo;
            document.getElementById('editDescricao').value = transaction.descricao;
            document.getElementById('editValor').value = transaction.valor;
            document.getElementById('editData').value = transaction.data;
            document.getElementById('editParcelGroupId').value = transaction.parcel_group_id || '';
            document.getElementById('editParcelado').value = transaction.parcelado ? 'true' : 'false';
            
            // Se for parcelada, mostra campos de parcelas
            if (transaction.parcelado) {
                document.getElementById('editParcelasGroup').style.display = 'block';
                document.getElementById('editNumParcelas').value = transaction.total_parcelas || 1;
                document.getElementById('editValor').value = transaction.valor_total || transaction.valor;
                updateEditParcelasInfo();
            } else {
                document.getElementById('editParcelasGroup').style.display = 'none';
                document.getElementById('editParcelasInfo').style.display = 'none';
            }
            
            modal.style.display = 'block';
        }

        // Fecha modal de edi√ß√£o
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Atualiza info de parcelas no modal
        function updateEditParcelasInfo() {
            const numParcelas = parseInt(document.getElementById('editNumParcelas').value) || 1;
            const valorTotal = parseFloat(document.getElementById('editValor').value) || 0;
            const infoDiv = document.getElementById('editParcelasInfo');
            
            if (numParcelas > 1 && valorTotal > 0) {
                const valorParcela = valorTotal / numParcelas;
                infoDiv.innerHTML = `<strong>‚ÑπÔ∏è Informa√ß√£o:</strong> ${numParcelas}x de ${formatCurrency(valorParcela)} = Total: ${formatCurrency(valorTotal)}`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Submit do formul√°rio de edi√ß√£o
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const transactionId = document.getElementById('editId').value;
            const tipo = document.getElementById('editTipo').value;
            const isParcelado = document.getElementById('editParcelado').value === 'true';
            
            const formData = {
                tipo: document.getElementById('editTipoSelect').value,
                descricao: document.getElementById('editDescricao').value,
                valor: parseFloat(document.getElementById('editValor').value),
                data: document.getElementById('editData').value,
            };
            
            if (isParcelado) {
                formData.num_parcelas = parseInt(document.getElementById('editNumParcelas').value) || 1;
                formData.valor_total = formData.valor;
            }
            
            try {
                const response = await fetch(`/api/transactions/${tipo}/${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Salva o filtro atual
                    const currentFilterMes = document.getElementById('filterMes').value;
                    const currentFilterTipo = document.getElementById('filterTipo').value;
                    const currentFilterBusca = document.getElementById('filterBusca').value;
                    
                    closeEditModal();
                    showMessage('‚úì Transa√ß√£o atualizada com sucesso!', 'success');
                    await loadTransactions();
                    // Restaura os filtros
                    document.getElementById('filterMes').value = currentFilterMes;
                    document.getElementById('filterTipo').value = currentFilterTipo;
                    document.getElementById('filterBusca').value = currentFilterBusca;
                    renderTransactions();
                } else {
                    showMessage('‚úó Erro: ' + (result.error || 'Erro ao atualizar'), 'error');
                }
            } catch (error) {
                showMessage('‚úó Erro de conex√£o: ' + error.message, 'error');
            }
        });

        // Event listeners para parcelas no modal
        document.getElementById('editNumParcelas').addEventListener('input', updateEditParcelasInfo);
        document.getElementById('editValor').addEventListener('input', updateEditParcelasInfo);

        // Fecha modal ao clicar fora
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const editAbatimentoModal = document.getElementById('editAbatimentoModal');
            if (event.target == editModal) {
                closeEditModal();
            }
            if (event.target == editAbatimentoModal) {
                closeEditAbatimentoModal();
            }
        }


        // Fun√ß√£o para atualizar dashboard quando o filtro de m√™s muda
        async function updateDashboardOnMonthChange() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                const dashboardMonth = document.getElementById('dashboardMonth').value;
                updateDashboard(data, dashboardMonth);
                await loadFaturas();
                await atualizarSaldos();
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        // Fun√ß√£o para atualizar tabela quando o filtro muda
        function updateOnFilterChange() {
            renderTransactions();
        }

        // Define m√™s atual como padr√£o para o dashboard
        const now = new Date();
        const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('dashboardMonth').value = currentMonth;
        
        // Define data atual para o formul√°rio de abatimento
        document.getElementById('data_abatimento').valueAsDate = new Date();

        // Filtros
        document.getElementById('dashboardMonth').addEventListener('change', () => {
            updateDashboardOnMonthChange();
            loadFaturas();
            loadStatistics();
        });
        document.getElementById('filterMes').addEventListener('change', updateOnFilterChange);
        document.getElementById('filterTipo').addEventListener('change', renderTransactions);
        document.getElementById('filterBusca').addEventListener('input', renderTransactions);

        // Event listeners
        document.getElementById('num_parcelas').addEventListener('input', updateParcelasInfo);
        document.getElementById('valor').addEventListener('input', updateParcelasInfo);
        document.getElementById('data').valueAsDate = new Date();

        // Carrega faturas do m√™s atual
        async function loadFaturas() {
            try {
                const dashboardMonth = document.getElementById('dashboardMonth').value;
                const monthParam = dashboardMonth ? `?month=${dashboardMonth}` : '';
                const response = await fetch('/api/faturas' + monthParam);
                const data = await response.json();
                
                // Atualiza cards do Mercado Pago
                document.getElementById('faturaAtualMP').textContent = formatCurrency(data.mercado_pago.atual);
                document.getElementById('faturaAbatidaMP').textContent = formatCurrency(data.mercado_pago.abatido);
                
                // Atualiza cards do Nubank
                document.getElementById('faturaAtualNubank').textContent = formatCurrency(data.nubank.atual);
                document.getElementById('faturaAbatidaNubank').textContent = formatCurrency(data.nubank.abatido);
                
                // Atualiza saldos ap√≥s atualizar os cards de faturas
                await atualizarSaldos();
            } catch (error) {
                console.error('Erro ao carregar faturas:', error);
            }
        }

        // Atualiza saldo atual e projetado (acumulativo)
        async function atualizarSaldos() {
            try {
                const dashboardMonth = document.getElementById('dashboardMonth').value;
                const response = await fetch('/api/transactions');
                const data = await response.json();
                
                // Busca abatimentos
                const abatimentosResponse = await fetch('/api/abatimentos');
                const abatimentos = await abatimentosResponse.json();
                
                // Agrupa transa√ß√µes por m√™s
                const monthlyData = {};
                
                // Processa receitas
                (data.receitas || []).forEach(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { receitas: 0, debito: 0, abatimentos: 0, faturas: 0 };
                    }
                    monthlyData[monthKey].receitas += t.valor;
                });
                
                // Processa d√©bitos
                (data.gastos_debito || []).forEach(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { receitas: 0, debito: 0, abatimentos: 0, faturas: 0 };
                    }
                    monthlyData[monthKey].debito += t.valor;
                });
                
                // Processa faturas (cart√µes de cr√©dito)
                [...(data.gastos_mercado_pago || []), ...(data.gastos_nubank || [])].forEach(t => {
                    const transDate = new Date(t.data + 'T00:00:00');
                    const monthKey = transDate.getFullYear() + '-' + String(transDate.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { receitas: 0, debito: 0, abatimentos: 0, faturas: 0 };
                    }
                    monthlyData[monthKey].faturas += t.valor;
                });
                
                // Processa abatimentos
                (abatimentos || []).forEach(a => {
                    const abatDate = new Date(a.data + 'T00:00:00');
                    const monthKey = abatDate.getFullYear() + '-' + String(abatDate.getMonth() + 1).padStart(2, '0');
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { receitas: 0, debito: 0, abatimentos: 0, faturas: 0 };
                    }
                    monthlyData[monthKey].abatimentos += parseFloat(a.valor);
                });
                
                // Ordena meses cronologicamente
                const sortedMonths = Object.keys(monthlyData).sort();
                
                // Calcula saldo acumulado at√© o m√™s selecionado (ou todos se n√£o houver filtro)
                let saldoAcumuladoAtual = 0;
                let saldoAcumuladoProjetado = 0;
                
                for (const month of sortedMonths) {
                    const monthData = monthlyData[month];
                    const saldoMesAtual = monthData.receitas - monthData.debito - monthData.abatimentos;
                    const saldoMesProjetado = monthData.receitas - monthData.debito - monthData.faturas;
                    
                    saldoAcumuladoAtual += saldoMesAtual;
                    saldoAcumuladoProjetado += saldoMesProjetado;
                    
                    // Para quando chegar no m√™s selecionado
                    if (dashboardMonth && month === dashboardMonth) {
                        break;
                    }
                }
                
                // Se n√£o h√° filtro, usa todos os meses (j√° calculado acima)
                
                // Atualiza cards
                const saldoAtualEl = document.getElementById('saldoAtual');
                saldoAtualEl.textContent = formatCurrency(saldoAcumuladoAtual);
                saldoAtualEl.className = 'card-value ' + (saldoAcumuladoAtual >= 0 ? 'positive' : 'negative');
                
                const saldoProjetadoEl = document.getElementById('saldoProjetado');
                saldoProjetadoEl.textContent = formatCurrency(saldoAcumuladoProjetado);
                saldoProjetadoEl.className = 'card-value ' + (saldoAcumuladoProjetado >= 0 ? 'positive' : 'negative');
            } catch (error) {
                console.error('Erro ao calcular saldos:', error);
            }
        }

        // Submit do formul√°rio de abatimento
        document.getElementById('abatimentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                tipo_cartao: document.getElementById('tipo_cartao_abatimento').value,
                valor: parseFloat(document.getElementById('valor_abatimento').value),
                data: document.getElementById('data_abatimento').value,
                descricao: document.getElementById('descricao_abatimento').value || ''
            };
            
            try {
                const response = await fetch('/api/abatimentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    document.getElementById('abatimentoForm').reset();
                    document.getElementById('data_abatimento').valueAsDate = new Date();
                    showAbatimentoMessage('‚úì Abatimento adicionado com sucesso!', 'success');
                    await loadFaturas();
                    await loadAbatimentos();
                    loadTransactions(); // Recarrega para atualizar tudo
                } else {
                    showAbatimentoMessage('‚úó Erro: ' + (result.error || 'Erro ao adicionar abatimento'), 'error');
                }
            } catch (error) {
                showAbatimentoMessage('‚úó Erro de conex√£o: ' + error.message, 'error');
            }
        });

        // Mostra mensagem de abatimento
        function showAbatimentoMessage(text, type) {
            const msg = document.getElementById('abatimentoMessage');
            msg.textContent = text;
            msg.className = 'alert ' + type;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        // Carrega e renderiza abatimentos
        async function loadAbatimentos() {
            try {
                const response = await fetch('/api/abatimentos');
                const abatimentos = await response.json();
                
                renderAbatimentos(abatimentos);
            } catch (error) {
                console.error('Erro ao carregar abatimentos:', error);
            }
        }

        // Renderiza tabela de abatimentos
        function renderAbatimentos(abatimentos) {
            const tbody = document.getElementById('abatimentosTableBody');
            
            if (!abatimentos || abatimentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888; padding: 40px;">Nenhum abatimento encontrado</td></tr>';
                return;
            }
            
            // Ordena por data (mais recente primeiro)
            const sorted = [...abatimentos].sort((a, b) => new Date(b.data) - new Date(a.data));
            
            tbody.innerHTML = sorted.map(abatimento => {
                const cartaoLabel = abatimento.tipo_cartao === 'mercado_pago' 
                    ? 'üõí Mercado Pago' 
                    : 'üíú Nubank';
                
                return `
                    <tr>
                        <td>${formatDate(abatimento.data)}</td>
                        <td>${cartaoLabel}</td>
                        <td>${abatimento.descricao || '-'}</td>
                        <td style="font-weight: 500; color: #4ade80;">${formatCurrency(abatimento.valor)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="edit-btn" onclick="openEditAbatimentoModal(${JSON.stringify(abatimento).replace(/"/g, '&quot;')})">Editar</button>
                                <button class="delete-btn" onclick="deleteAbatimento('${abatimento.id}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Abre modal de edi√ß√£o de abatimento
        function openEditAbatimentoModal(abatimento) {
            const modal = document.getElementById('editAbatimentoModal');
            document.getElementById('editAbatimentoId').value = abatimento.id;
            document.getElementById('editAbatimentoTipoCartao').value = abatimento.tipo_cartao;
            document.getElementById('editAbatimentoValor').value = abatimento.valor;
            document.getElementById('editAbatimentoData').value = abatimento.data;
            document.getElementById('editAbatimentoDescricao').value = abatimento.descricao || '';
            
            modal.style.display = 'block';
        }

        // Fecha modal de edi√ß√£o de abatimento
        function closeEditAbatimentoModal() {
            document.getElementById('editAbatimentoModal').style.display = 'none';
        }

        // Deleta abatimento
        async function deleteAbatimento(id) {
            if (!confirm('Deseja realmente excluir este abatimento?')) return;
            
            try {
                const response = await fetch(`/api/abatimentos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await loadAbatimentos();
                    await loadFaturas();
                    showAbatimentoMessage('Abatimento exclu√≠do com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showAbatimentoMessage('Erro ao excluir abatimento', 'error');
            }
        }

        // Submit do formul√°rio de edi√ß√£o de abatimento
        document.getElementById('editAbatimentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const abatimentoId = document.getElementById('editAbatimentoId').value;
            
            const formData = {
                tipo_cartao: document.getElementById('editAbatimentoTipoCartao').value,
                valor: parseFloat(document.getElementById('editAbatimentoValor').value),
                data: document.getElementById('editAbatimentoData').value,
                descricao: document.getElementById('editAbatimentoDescricao').value || ''
            };
            
            try {
                const response = await fetch(`/api/abatimentos/${abatimentoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    closeEditAbatimentoModal();
                    showAbatimentoMessage('‚úì Abatimento atualizado com sucesso!', 'success');
                    await loadAbatimentos();
                    await loadFaturas();
                } else {
                    showAbatimentoMessage('‚úó Erro: ' + (result.error || 'Erro ao atualizar'), 'error');
                }
            } catch (error) {
                showAbatimentoMessage('‚úó Erro de conex√£o: ' + error.message, 'error');
            }
        });


        // Cria anima√ß√£o minimalista
        function createChristmasAnimation() {
            const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
            const snowContainer = document.getElementById('snowflakes');
            
            // Cria apenas alguns flocos de neve sutis
            for (let i = 0; i < 20; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
                snowflake.style.left = Math.random() * 100 + '%';
                snowflake.style.animationDuration = (Math.random() * 10 + 15) + 's';
                snowflake.style.animationDelay = Math.random() * 10 + 's';
                snowflake.style.opacity = Math.random() * 0.2 + 0.1;
                snowContainer.appendChild(snowflake);
            }
        }

        // Carrega dados iniciais
        (async () => {
            createChristmasAnimation();
            await loadTransactions();
            await loadFaturas();
            await loadAbatimentos();
            // Calcula saldos ap√≥s carregar tudo
            await atualizarSaldos();
        })();
    </script>
</body>
</html>
